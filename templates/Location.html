{% include "header.html" %}

<div class="container-fluid location">
  <div class="row">
    {% if nearLocationsLen==0 %}
    <div class="col-lg-12 loc-1">
    {% else %}
    <div class="col-lg-6 loc-2">
    {% endif %}
      <div class="row">
        <div class="col-lg-6">
          <h3>Choose Your Location</h3>
        </div>

        <div class="col-lg-6">
          <form action="/location" method="POST">
            <button type="submit" class="btn btn-primary btn-lg" onclick="window.location.href='{{ url_for('location') }}';">Find The Ambulance</button>
          </form>
        </div>
      </div>
      <div class="row">
        <div id="map"></div>
      </div>
    </div>
    {% if nearLocationsLen!=0 %}
    <div class="col-lg-6 location-data">
      <h3>Nearest Locations</h3>
      {% for Ambulance in  nearestAmbulancedricers %}
      <div class="container shadow ps-4 pe-4 mb-3 bg-white rounded">
        <div class="row">
          <div class="col-lg-10 mt-3">
            <h4>{{Ambulance.name}}</h4>
            <p>{{Ambulance.phone}}</p>
          </div>
          <div class="col-lg-2 Direct">
            <form action="/bookAmbulance" method="POST">
              <input type="hidden" id="custId" name="driverId" value="{{Ambulance.id}}">
              <button type="submit" class="btn btn-primary">Book</button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
    {% endif %}
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
<script>
  let latitude = 21.538369;
  let longitude = 78.706055;
  var map = L.map('map').setView([latitude, longitude], 5);

  L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; <a href="http://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition);
    } else {
      alert("Geolocation is not supported by this browser.");
    }
  }

  function showPosition(position) {
    latitude = position.coords.latitude;
    longitude = position.coords.longitude;

    document.getElementById("latitude").value = latitude;
    document.getElementById("longitude").value = longitude;

    map.setView([latitude, longitude], 15); // Set map view to current location

    var marker = L.marker([latitude, longitude]).addTo(map); // Add marker at current location
    marker.bindPopup("Your Current Location").openPopup(); // Open a popup for the marker
    sendinfo(); // Send location info
  }

  map.on('click', onMapClick);
  var popup = L.popup();

  function onMapClick(e) {
    popup
      .setLatLng(e.latlng)
      .setContent("You clicked this Location at " + e.latlng.toString())
      .openOn(map);
  }

  function sendinfo(e) {
    let userinfo = {
      'values': '' + e.latlng.toString()
    }
    const request = new XMLHttpRequest()
    request.open('POST', `/process/${JSON.stringify(userinfo)}`)
    request.onload = () => {
      const flaskMessage = request.responseText
      console.log(flaskMessage)
    }
    request.send()
  }
  map.on('click', onMapClick);
  map.on('click', sendinfo);
</script>

{% include "footer.html" %}
